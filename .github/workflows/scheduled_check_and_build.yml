name: scheduled-check-and-build

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_OWNER: Kaliiiiiiiiii-Vinyzu
      UPSTREAM_REPO: patchright

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest upstream tag
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const { data: release } = await github.rest.repos.getLatestRelease({
              owner: process.env.UPSTREAM_OWNER,
              repo: process.env.UPSTREAM_REPO
            });
            core.setOutput("tag", release.tag_name);

      - name: Read previous tag
        id: read_prev
        run: echo "prev=$(cat .last_patchright_release 2>/dev/null || true)" >> $GITHUB_OUTPUT

      - name: Lowercase repo owner
        id: owner_lc
        run: echo "owner_lc=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # LOGIN: Runs on update OR manual trigger
      - name: Login to GHCR
        if: |
          github.event_name == 'workflow_dispatch' || 
          steps.get_release.outputs.tag != steps.read_prev.outputs.prev
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # BUILD: Runs on update OR manual trigger
      - name: Build and push
        if: |
          github.event_name == 'workflow_dispatch' || 
          steps.get_release.outputs.tag != steps.read_prev.outputs.prev
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.owner_lc.outputs.owner_lc }}/patchright:latest
            ghcr.io/${{ steps.owner_lc.outputs.owner_lc }}/patchright:${{ steps.get_release.outputs.tag }}

      # UPDATE CACHE: Only runs if there's an actual new version
      - name: Update release tracker
        if: steps.get_release.outputs.tag != steps.read_prev.outputs.prev
        run: |
          echo "${{ steps.get_release.outputs.tag }}" > .last_patchright_release
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_patchright_release
          git commit -m "chore: update patchright version to ${{ steps.get_release.outputs.tag }}"
          git push