# I'm building this with a couple references. chatgpt got me started, but did poorly as always. 
# https://dev.to/willvelida/pushing-container-images-to-github-container-registry-with-github-actions-1m6b
# This article seems like a good place to start

name: Build image on upstream release (patchright-nodejs)

# run on schedule (every 15 minutes) and manually
on:
  # workflow_dispatch: # This runs the script on every commit.
  # schedule: #TODO Uncomment when I want this to run automatically
  #   - cron: '0 */6 * * *'   # runs every 6 hours, on the hour. Is this too often?

permissions:
  contents: read

jobs:
  build-on-release:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_OWNER: "Kaliiiiiiiiii-Vinyzu"
      UPSTREAM_REPO: "patchright-nodejs"
    steps:

    
      - name: Get latest upstream release tag
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const owner = process.env.UPSTREAM_OWNER;
            const repo = process.env.UPSTREAM_REPO;
            const release = await github.rest.repos.getLatestRelease({ owner, repo });
            return release.data.tag_name;
      # latest tag is available as steps.get_release.outputs.result


      - name: Checkout (for build context) #I don't know what this does. What is it checking out? This repo?
        uses: actions/checkout@main


      - name: Check if image for this tag already exists in registry
        id: check_image
        run: |
          IMAGE="${{ env.REGISTRY_IMAGE }}"
          TAG="${{ steps.get_release.outputs.result }}"
          echo "Checking $IMAGE:$TAG"
          # Try to pull the image; success => exists=true
          if docker pull "$IMAGE:$TAG"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi



      - name: Build and push (only if image missing)
        if: steps.check_image.outputs.exists == 'false'
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # tag with release tag and latest
          tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ steps.get_release.outputs.result }}
            ${{ env.REGISTRY_IMAGE }}:latest
          # optionally enable buildx cache; configure if you want
          # cache-from: type=gha
          # cache-to: type=gha,mode=max


          
      - name: 'Login to GitHub Container Registry'
            uses: docker/login-action@v1
            with:
              registry: ghcr.io
              username: ${{github.actor}}
              password: ${{secrets.GITHUB_TOKEN}}



      - name: Notify already built
        if: steps.check_image.outputs.exists == 'true'
        run: echo "Image already exists for tag ${{ steps.get_release.outputs.result }}; skipping build."
